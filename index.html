<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Omega Signet v12.8 - High Resolution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: #cbd5e1; font-family: 'Courier New', monospace; overflow: hidden; }
        .glow-purple { box-shadow: 0 0 30px rgba(188, 19, 254, 0.3); }
        .scan-line { width: 100%; height: 2px; background: linear-gradient(90deg, transparent, #BC13FE, transparent); position: absolute; top: 0; animation: scan 3s linear infinite; }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
        .heart-pulse { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.05); opacity: 1; } }
    </style>
</head>
<body class="flex flex-col h-screen p-6 relative">
    <div class="scan-line"></div>

    <header class="flex justify-between items-center mb-6 z-10">
        <div>
            <h1 class="text-xl font-black text-white italic tracking-tighter">OMEGA<span class="text-[#BC13FE]">SIGNET</span></h1>
            <p id="dev-id" class="text-[8px] text-slate-500 uppercase">NODE: UNLINKED</p>
        </div>
        <div id="status-dot" class="w-2 h-2 rounded-full bg-red-600"></div>
    </header>

    <main class="flex-1 flex flex-col items-center justify-around z-10">
        <!-- MONITOR CENTRAL -->
        <div id="main-display" class="relative w-64 h-64 flex items-center justify-center border border-slate-900 rounded-full">
            <div class="absolute inset-4 border border-slate-800/50 rounded-full animate-spin-slow"></div>
            <div class="text-center">
                <div id="bpm-val" class="text-7xl font-black text-white italic leading-none">--</div>
                <div class="text-[10px] text-purple-500 font-bold tracking-[0.3em] mt-2">PULSE_BPM</div>
            </div>
        </div>

        <!-- DATOS DE MALLA -->
        <div class="w-full grid grid-cols-2 gap-4">
            <div class="bg-slate-950 p-4 rounded-xl border border-slate-800">
                <div class="text-[9px] text-slate-500 uppercase mb-1">Coherencia (HRV)</div>
                <div id="coh-val" class="text-2xl font-black text-cyan-400">0.0<span class="text-xs ml-1">%</span></div>
            </div>
            <div class="bg-slate-950 p-4 rounded-xl border border-slate-800">
                <div class="text-[9px] text-slate-500 uppercase mb-1">Fase de Red</div>
                <div id="link-status" class="text-lg font-black text-slate-600 uppercase">Offline</div>
            </div>
        </div>

        <button id="btn-connect" class="w-full py-5 bg-[#BC13FE] text-white font-black rounded-2xl glow-purple active:scale-95 transition-all text-xs tracking-widest uppercase">
            Sincronizar Clave Cuántica
        </button>
    </main>

    <footer class="mt-4">
        <div class="text-[8px] text-slate-600 text-center uppercase leading-relaxed">
            24/7 Persistent Bio-Link | Sentinel Node v12.8.1<br>
            Aether-Shield Encription: ACTIVE
        </div>
    </footer>

    <script>
        const VPS_URL = "http://64.71.161.170:8000"; // Tu IP de VPS
        let rrIntervals = [];

        const btn = document.getElementById('btn-connect');
        const bpmEl = document.getElementById('bpm-val');
        const cohEl = document.getElementById('coh-val');
        const linkEl = document.getElementById('link-status');
        const dot = document.getElementById('status-dot');

        btn.onclick = async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['heart_rate'] }]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('heart_rate');
                const char = await service.getCharacteristic('heart_rate_measurement');

                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', handleData);
                
                btn.innerText = "SISTEMA VINCULADO";
                btn.style.backgroundColor = "#059669";
                dot.style.backgroundColor = "#22c55e";
                linkEl.innerText = "Sincronizado";
                linkEl.classList.replace('text-slate-600', 'text-green-500');
            } catch (e) {
                console.log(e);
            }
        };

        function handleData(event) {
            const data = event.target.value;
            const bpm = data.getUint8(1);
            bpmEl.innerText = bpm;

            // Extraer Intervalos RR para coherencia real
            let offset = 2;
            const hasRR = data.getUint8(0) & 0x10;
            if (hasRR) {
                while (offset < data.byteLength) {
                    const rr = data.getUint16(offset, true);
                    rrIntervals.push(rr);
                    if (rrIntervals.length > 20) rrIntervals.shift();
                    offset += 2;
                }
            }

            // Cálculo de Coherencia basado en RMSSD (Real HRV)
            let coherence = 0;
            if (rrIntervals.length > 2) {
                let diffs = [];
                for (let i = 1; i < rrIntervals.length; i++) {
                    diffs.push(Math.pow(rrIntervals[i] - rrIntervals[i-1], 2));
                }
                const rmssd = Math.sqrt(diffs.reduce((a,b) => a+b) / diffs.length);
                coherence = Math.min(100, (rmssd / 20) * 100).toFixed(1);
            }
            
            cohEl.innerText = coherence + "%";

            // Enviar al VPS (Background Sync)
            fetch(`${VPS_URL}/biometric_update`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ bpm: bpm, coherence: parseFloat(coherence) })
            }).catch(() => {});
        }
    </script>
</body>
</html>
